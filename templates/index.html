<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Smart Audio Validator</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

  <style>
    .fade-in {
      animation: fadeIn 0.8s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .star {
      animation: pop 0.4s ease forwards;
    }

    @keyframes pop {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-100 via-slate-50 to-indigo-100 min-h-screen text-slate-800">

  <!-- Particle Canvas -->
  <canvas id="particleCanvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

  <!-- NAVBAR -->
  <nav class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center">

      <!-- Logo / Project Name -->
      <h1 class="text-lg font-semibold tracking-tight text-slate-900">
        Audex <span class="text-indigo-600">Audio Validator</span>
      </h1>

    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="relative z-10 max-w-7xl mx-auto mt-16 px-6">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

      <!-- LEFT: UPLOAD CARD -->
      <div
        class="bg-white/70 backdrop-blur-xl p-8 rounded-2xl shadow-lg border border-slate-200 h-[50vh] flex flex-col">
        <h2 class="text-xl font-semibold text-slate-800 mb-1">
          Upload Audio File
        </h2>

        <p class="text-xs text-slate-500 mb-4">
          Upload a WAV file to evaluate song quality
        </p>
        <div class="space-y-6">
          <form id="audioForm" enctype="multipart/form-data">
            <input type="file" name="audio" accept=".wav" class="block w-full text-sm text-slate-600
            file:mr-4 file:py-2 file:px-4
            file:rounded-lg file:border
            file:border-slate-300
            file:bg-slate-100 file:text-slate-700
            hover:file:bg-slate-200 mb-4 transition" required>

            <button type="submit" id="analyzeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700
            text-white py-2.5 rounded-lg font-medium
            transition shadow-md">
              Analyze Audio
            </button>

            <!-- üé§ Live Recording Section -->
            <div class="mt-6 pt-5 border-t border-slate-200">
              <p class="text-sm font-medium text-slate-700 mb-4">
                Live Recording
                <span class="text-xs text-slate-400">(Sing or play music)</span>
              </p>

              <div class="flex items-center gap-4">

                <!-- Record Button -->
                <button id="recordBtn" class="w-12 h-12 rounded-full bg-rose-500 text-white
                  flex items-center justify-center
                  shadow-md hover:scale-105 transition relative">

                  <!-- Mic Icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 1v10m0 0a3 3 0 003-3V5a3 3 0 00-6 0v3a3 3 0 003 3zm0 0v6m-4 0h8" />
                  </svg>

                  <!-- Pulsing ring (hidden by default) -->
                  <span id="recordPulse"
                    class="absolute inset-0 rounded-full border-4 border-red-400 animate-ping hidden">
                  </span>
                </button>

                <!-- Stop Button -->
                <button id="stopBtn" disabled class="w-12 h-12 rounded-full bg-slate-200 text-slate-600
                  flex items-center justify-center
                  shadow-sm cursor-not-allowed transition">

                  <!-- Stop Icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="6" width="12" height="12" rx="2" />
                  </svg>
                </button>

                <!-- Status -->
                <span id="recordStatus" class="text-xs text-slate-500"></span>
              </div>
            </div>


          </form>
        </div>
      </div>

      <!-- RIGHT: RESULT CARD (EMPTY STATE) -->
      <div id="resultCard"
        class="bg-white/70 backdrop-blur-xl rounded-2xl shadow-lg border border-slate-200 h-[75vh] flex flex-col">
        <div class="p-6 border-b border-slate-200 bg-white/60 backdrop-blur-md sticky top-0 z-10">
          <h2 class="text-xl font-semibold text-slate-800 mb-1">
            Analysis Result
          </h2>
          <p class="text-xs text-slate-500 mb-4">
            Audio quality evaluation & recommendations
          </p>
        </div>

        <div class="p-8 overflow-y-auto scrollbar-thin">
          <div id="resultEmpty" class="text-gray-500 text-sm">
            Upload an audio file to view quality score and recommendations.
          </div>

          <!-- Loading Animation -->
          <div id="loadingState" class="hidden flex items-center justify-center mt-6">
            <div class="flex items-center gap-3">
              <div class="w-5 h-5 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              <span class="text-sm text-gray-600">Analyzing audio...</span>
            </div>
          </div>


          <div id="resultContent" class="hidden">

            <!-- Audio Waveform -->
            <div class="mt-2 p-4 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg">
              <h3 class="text-sm font-semibold mb-2">Audio Waveform</h3>
              <div class="bg-white rounded-xl p-3 shadow-inner border">
                <div id="waveform"></div>
              </div>

            </div>

            <!-- USER-FRIENDLY SUMMARY -->
            <div class="mb-4 mt-4">
              <p class="text-lg font-semibold">
                Overall Audio Quality:
                <span id="qualityText" class="font-bold"></span>
              </p>

              <p id="qualityDesc" class="text-gray-600 text-sm mt-1"></p>

              <!-- Star Rating -->
              <div id="starRating" class="flex mt-2 text-yellow-400 text-lg"></div>
            </div>

            <!-- TECHNICAL DETAILS -->
            <div class="mt-4 text-sm text-gray-600 border-t pt-3">
              <p><b>Technical Score (MOS):</b> <span id="mosVal"></span> / 5</p>

              <!-- Confidence Progress Bar -->
              <div class="mt-4">
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium text-slate-700">
                    Confidence Level
                  </span>
                  <span id="confidenceVal" class="text-sm text-slate-500">
                    0%
                  </span>
                </div>

                <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden">
                  <div id="confidenceBar" class="h-2.5 rounded-full transition-all duration-700 ease-out bg-indigo-500"
                    style="width: 0%">
                  </div>
                </div>

              </div>
            </div>

            <!-- RECOMMENDATIONS LIST -->
            <h3 class="mt-4 font-semibold">Recommendations</h3>
            <ul id="recList" class="list-disc ml-6 text-gray-700 text-sm"></ul>
          </div>
        </div>
      </div>


    </div>
  </div>


  <!-- Confidence Bar Update Script -->
  <script>
    function updateConfidenceBar(confidence) {
      const bar = document.getElementById("confidenceBar");
      const text = document.getElementById("confidenceVal"); // ‚úÖ FIXED ID

      if (!bar || !text) return;

      const value = Math.max(0, Math.min(100, Number(confidence)));

      // Update width + text
      bar.style.width = value + "%";
      text.innerText = value.toFixed(1) + "%";

      // Remove previous color classes
      bar.classList.remove(
        "bg-green-500",
        "bg-indigo-500",
        "bg-yellow-500",
        "bg-red-500"
      );

      // Add correct color
      if (value >= 75) {
        bar.classList.add("bg-green-500");
      } else if (value >= 50) {
        bar.classList.add("bg-indigo-500");
      } else if (value >= 30) {
        bar.classList.add("bg-yellow-500");
      } else {
        bar.classList.add("bg-red-500");
      }
    }
  </script>

  <!-- waveform.js initialization -->
  <script>
    let wavesurfer = WaveSurfer.create({
      container: "#waveform",
      waveColor: "#94a3b8",        // slate-400
      progressColor: "#475569",    // slate-600
      height: 90,
      responsive: true,
      barWidth: 2,
      barGap: 2,
      plugins: [
        WaveSurfer.Regions.create()
      ]
    });
  </script>

  <!-- Particle animation script -->
  <script>
    const canvas = document.getElementById("particleCanvas");
    const ctx = canvas.getContext("2d");
    let analysisData = null;

    let particles = [];
    const COUNT = 280;
    const INFLUENCE_RADIUS = 160;

    let mouse = { x: null, y: null };

    const symbols = ["‚ô™", "‚ô´", "‚ô©", "‚ô¨"];
    const BASE_RGB = "59,130,246";   // Tailwind blue-500

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener("resize", resize);

    window.addEventListener("mousemove", e => {
      mouse.x = e.clientX;
      mouse.y = e.clientY;
    });

    window.addEventListener("mouseleave", () => {
      mouse.x = null;
      mouse.y = null;
    });

    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;

        this.vx = Math.random() * 0.55 - 0.225; // increased speed
        this.vy = Math.random() * 0.55 - 0.225; // increased speed

        this.size = Math.random() * 14 + 10;
        this.symbol = symbols[Math.floor(Math.random() * symbols.length)];

        this.angle = Math.random() * Math.PI * 2;
        this.spin = Math.random() * 0.01 - 0.005;

        this.opacity = 0.6;
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.angle += this.spin;
        this.targetOpacity = 1;     // or 0.02 / 0.15
        this.opacity += (this.targetOpacity - this.opacity) * 0.08;


        if (mouse.x !== null) {
          const dx = this.x - mouse.x;
          const dy = this.y - mouse.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < INFLUENCE_RADIUS) {
            const force = (INFLUENCE_RADIUS - dist) / INFLUENCE_RADIUS;
            this.x += (dx / dist) * force * 6;
            this.y += (dy / dist) * force * 6;
            this.opacity = 1;
          } else {
            this.opacity = 0.02;   // üî• fade out strongly
          }
        } else {
          this.opacity = 0.15;     // üî• default faint state
        }


        // Wrap around edges
        if (this.x < -50) this.x = canvas.width + 50;
        if (this.x > canvas.width + 50) this.x = -50;
        if (this.y < -50) this.y = canvas.height + 50;
        if (this.y > canvas.height + 50) this.y = -50;
      }

      draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.font = `${this.size}px Arial`;
        ctx.fillStyle = `rgba(${BASE_RGB}, ${this.opacity})`;
        ctx.fillText(this.symbol, -this.size / 2, this.size / 2);
        ctx.restore();
      }
    }


    function init() {
      particles = [];
      for (let i = 0; i < COUNT; i++) {
        particles.push(new Particle());
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.update();
        p.draw();
      });
      requestAnimationFrame(animate);
    }

    init();
    animate();

    wavesurfer.on("ready", () => {
      wavesurfer.clearRegions();

      if (analysisData.error_segments) {
        analysisData.error_segments.forEach(seg => {
          wavesurfer.addRegion({
            start: seg.start,
            end: seg.end,
            color: "rgba(239, 68, 68, 0.4)", // üî¥ red highlight
            drag: false,
            resize: false
          });
        });
      }
    });

    function getRegionColor(type) {
      switch (type) {
        case "clipping": return "rgba(220, 38, 38, 0.5)";
        case "noise": return "rgba(245, 158, 11, 0.5)";
        case "low_energy": return "rgba(59, 130, 246, 0.4)";
        default: return "rgba(107, 114, 128, 0.3)";
      }
    }
  </script>

  <!-- AJAX form submission script -->
  <script>
    function updateUserFriendlyResult(mos, quality) {
      const qualityText = document.getElementById("qualityText");
      const qualityDesc = document.getElementById("qualityDesc");
      const starRating = document.getElementById("starRating");

      let stars = 0;
      let desc = "";

      if (mos >= 4.2) {
        stars = 5;
        desc = "Excellent audio quality. Sounds professional and well balanced.";
      } else if (mos >= 3.5) {
        stars = 4;
        desc = "Good quality. Minor improvements can make it sound better.";
      } else if (mos >= 2.8) {
        stars = 3;
        desc = "Average quality. Noticeable issues that can be improved.";
      } else if (mos >= 2.0) {
        stars = 2;
        desc = "Poor quality. Multiple issues detected in the audio.";
      } else {
        stars = 1;
        desc = "Very poor quality. Re-recording is strongly recommended.";
      }

      qualityText.innerText = `${stars} / 5`;
      qualityDesc.innerText = desc;

      // Render stars
      starRating.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        starRating.innerHTML += i < stars ? "‚òÖ" : "‚òÜ";
      }
    }

    const form = document.getElementById("audioForm");
    const loadingState = document.getElementById("loadingState");
    const analyzeBtn = document.getElementById("analyzeBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fileInput = form.querySelector("input[type=file]");
      if (!fileInput.files.length) return;

      // üîÑ Show loader
      loadingState.classList.remove("hidden");
      document.getElementById("resultContent").classList.add("hidden");
      document.getElementById("resultEmpty").classList.add("hidden");
      analyzeBtn.disabled = true;
      analyzeBtn.innerText = "Analyzing...";

      const formData = new FormData();
      formData.append("audio", fileInput.files[0]);

      wavesurfer.loadBlob(fileInput.files[0]);

      const res = await fetch("/analyze_ajax", {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      // üîÑ Hide loader
      loadingState.classList.add("hidden");
      analyzeBtn.disabled = false;
      analyzeBtn.innerText = "Analyze Audio";

      // Populate result
      document.getElementById("resultContent").classList.remove("hidden");

      document.getElementById("mosVal").innerText = data.mos;
      document.getElementById("confidenceVal").innerText = data.confidence;
      updateConfidenceBar(data.confidence);
      updateUserFriendlyResult(data.mos);

      const list = document.getElementById("recList");
      list.innerHTML = "";

      data.recommendations.forEach(r => {
        const li = document.createElement("li");
        li.className = "mb-3";

        li.innerHTML = `
        <div class="mb-4 p-4 bg-white rounded-xl border shadow-sm hover:shadow-md transition">
          <div class="flex items-start gap-3">
            <div class="text-xl">‚ö†Ô∏è</div>
            <div>
              <p class="font-semibold text-slate-800">${r.issue}</p>
              <p class="text-sm text-slate-600">${r.message}</p>
              <p class="text-sm mt-1"><b>Fix:</b> ${r.fix}</p>
              <a href="${r.youtube}" target="_blank"
                class="inline-block mt-2 text-blue-600 text-sm hover:underline">
                ‚ñ∂ Watch tutorial
              </a>
            </div>
          </div>
        </div>
  `;

        list.appendChild(li);
      });


      // üé® Update particles based on model output
      updateParticleTheme(data.quality, data.loudness, data.pitch_std);
    });

  </script>

  <!-- WAV Conversion Script -->
  <script>
    async function convertToWav(blob) {
      const audioCtx = new AudioContext();
      const arrayBuffer = await blob.arrayBuffer();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

      const numChannels = audioBuffer.numberOfChannels;
      const sampleRate = audioBuffer.sampleRate;
      const length = audioBuffer.length * numChannels * 2;

      const buffer = new ArrayBuffer(44 + length);
      const view = new DataView(buffer);

      let offset = 0;

      function writeString(str) {
        for (let i = 0; i < str.length; i++) {
          view.setUint8(offset++, str.charCodeAt(i));
        }
      }

      writeString("RIFF");
      view.setUint32(offset, 36 + length, true); offset += 4;
      writeString("WAVE");
      writeString("fmt ");
      view.setUint32(offset, 16, true); offset += 4;
      view.setUint16(offset, 1, true); offset += 2;
      view.setUint16(offset, numChannels, true); offset += 2;
      view.setUint32(offset, sampleRate, true); offset += 4;
      view.setUint32(offset, sampleRate * numChannels * 2, true); offset += 4;
      view.setUint16(offset, numChannels * 2, true); offset += 2;
      view.setUint16(offset, 16, true); offset += 2;
      writeString("data");
      view.setUint32(offset, length, true); offset += 4;

      const channels = [];
      for (let i = 0; i < numChannels; i++) {
        channels.push(audioBuffer.getChannelData(i));
      }

      for (let i = 0; i < audioBuffer.length; i++) {
        for (let c = 0; c < numChannels; c++) {
          const sample = Math.max(-1, Math.min(1, channels[c][i]));
          view.setInt16(offset, sample * 32767, true);
          offset += 2;
        }
      }

      return buffer;
    }
  </script>

  <!-- Audio Recording Script -->
  <script>
    let audioContext, mediaRecorder, audioStream;
    let audioChunks = [];

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordStatus = document.getElementById("recordStatus");

    recordBtn.onclick = async () => {
      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      mediaRecorder = new MediaRecorder(audioStream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        try {
          recordStatus.innerText = "Analyzing recording‚Ä¶";
          loadingState.classList.remove("hidden");
          document.getElementById("resultContent").classList.add("hidden");
          document.getElementById("resultEmpty").classList.add("hidden");

          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

          const rawWav = await convertToWav(audioBlob);
          const wavBlob = new Blob([rawWav], { type: "audio/wav" });

          // Load waveform
          wavesurfer.loadBlob(wavBlob);

          const fd = new FormData();
          fd.append("audio", wavBlob, "recorded.wav");

          console.log("Sending recorded WAV to backend...");

          const res = await fetch("/analyze_ajax", {
            method: "POST",
            body: fd
          });

          if (!res.ok) throw new Error("Backend error");

          const data = await res.json();
          analysisData = data;

          loadingState.classList.add("hidden");
          document.getElementById("resultContent").classList.remove("hidden");

          document.getElementById("mosVal").innerText = data.mos;
          document.getElementById("confidenceVal").innerText = data.confidence;
          updateConfidenceBar(data.confidence);
          updateUserFriendlyResult(data.mos);

          const list = document.getElementById("recList");
          list.innerHTML = "";

          data.recommendations.forEach(r => {
            list.innerHTML += `
        <div class="mb-4 p-4 bg-white rounded-xl border shadow-sm">
          <p class="font-semibold">‚ö†Ô∏è ${r.issue}</p>
          <p class="text-sm">${r.message}</p>
          <p class="text-sm"><b>Fix:</b> ${r.fix}</p>
          <a href="${r.youtube}" target="_blank"
             class="text-blue-600 text-sm hover:underline">
            ‚ñ∂ Watch tutorial
          </a>
        </div>
      `;
          });

          recordStatus.innerText = "Recording analyzed ‚úî";

        } catch (err) {
          console.error(err);
          recordStatus.innerText = "Recording analysis failed ‚ùå";
          loadingState.classList.add("hidden");
        }
      };


      mediaRecorder.start();

      recordStatus.innerText = "Recording‚Ä¶";
      recordBtn.disabled = true;
      stopBtn.disabled = false;

      recordBtn.classList.add("opacity-70");
      stopBtn.classList.remove("bg-slate-300", "cursor-not-allowed");
      stopBtn.classList.add("bg-slate-700");

      document.getElementById("recordPulse").classList.remove("hidden");
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      audioStream.getTracks().forEach(t => t.stop());

      recordBtn.disabled = false;
      stopBtn.disabled = true;

      recordBtn.classList.remove("opacity-70");
      stopBtn.classList.add("bg-slate-300", "cursor-not-allowed");
      stopBtn.classList.remove("bg-slate-700");

      recordStatus.innerText = "Recording stopped";
    };

  </script>


</body>

</html>